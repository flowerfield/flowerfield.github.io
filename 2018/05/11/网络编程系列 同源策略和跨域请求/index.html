<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 网络编程系列 同源策略和跨域请求 · 花田半亩</title><meta name="description" content="网络编程系列 同源策略和跨域请求 - 文顶顶"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/logo.jpeg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://weibo.com/u/3800117445/atom.xml" title="花田半亩"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/鲸鱼.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">文顶顶</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="https://www.cnblogs.com/wendingding/" target="_blank" class="nav-list-link">博客园</a></li><li class="nav-list-item"><a href="https://github.com/flowerField" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">网络编程系列 同源策略和跨域请求</h1><div class="post-info">May 11, 2018<span class="post-count"></span> ✧ 字数统计:1,821(字) &nbsp;&nbsp; ♨︎ 阅读时长:7(分钟)</div><div class="post-content"><h3 id="1-1-同源策略"><a href="#1-1-同源策略" class="headerlink" title="1.1 同源策略"></a>1.1 同源策略</h3><h4 id="1-1-1-同源策略说明"><a href="#1-1-1-同源策略说明" class="headerlink" title="1.1.1 同源策略说明"></a>1.1.1 同源策略说明</h4><p><strong>同源策略(Same Origin Policy)</strong>是一种约定，它是浏览器最核心也最基本的安全策略。可以说web是构建在同源策略的基础上的，浏览器只是针对同源策略的一种具体实现。</p>
<p>同源策略是浏览器实施的一种关键机制，主要用于防止不同来源的内容相互干扰产生安全问题。简单说，就是某个站点(源)可以读写从该站点(源)收到的信息，但是不得访问从其它站点(源)收到的信息，浏览器只允许相同来源的内容进行交互。</p>
<div class="tip">不使用同源策略的安全问题？</div>

<p>若不使用同源策略，那么当不知情的用户访问恶意网站的时候，该网站上运行的脚本将能够通过一定方式来访问这名用户同时访问的任何其他网站的数据和功能。<code>[用户在浏览器当前打开的其他页面中可能已经处理登录状态，脚本可以直接获取对应的Cookie数据或登录令牌发送对应网络请求。]</code> 这样的话，该恶意网站将可以操作用户的账户转账、阅读邮件列表等信息，存在巨大的安全风险。</p>
<p><strong>同源策略</strong>的主要特点</p>
<blockquote>
<p> ❐  指定域的页面可以向另一个域提出任意数量的请求，但是该页面本身无法处理返回的数据。<br> ❐  指定域的页面可以通过某些标签加载其它域的脚本并执行该脚本。<br> ❐  指定域的页面无法读取或修改其它域的cookie或DOM数据。</p>
</blockquote>
<p>目前，同源策略限制以下三种行为</p>
<blockquote>
<p> ❐  DOM  的读取操作。<br> ❐  AJAX 请求的发送。<br> ❐  Cookie、LocalStorage 和 IndexDB 的读取操作。</p>
</blockquote>
<p><strong>注意  </strong>Ajax在发送跨域请求的时候，其实请求是发出去的，只是服务器返回的响应(response)被浏览器阻塞了，即使是返回码也获取不到。</p>
<p><span style="color:red">同源策略其实是限制了不同源的读，但是并不限制不同源的写。</span></p>
<div class="tip">为什么不限制不同源的写操作？</div>

<p>因为如果连请求都发不出去，相当于在源头上就限制死各网站间无法共享资源了,而且仅仅限制读操作，也就是浏览器拦截跨域网络请求的响应结果一般来说就足够了,限制读但是不限制写这样的处理方式更灵活。</p>
<h4 id="1-1-2-同源策略和Ajax请求"><a href="#1-1-2-同源策略和Ajax请求" class="headerlink" title="1.1.2 同源策略和Ajax请求"></a>1.1.2 同源策略和Ajax请求</h4><p><div class="tip">如何确定是否同源？</div></p>
<blockquote>
<p> ❐  协议相同<br> ❐  域名相同<br> ❐  端口相同<br><code>协议 + 域名 + 端口号</code>完全相同则认为是同源的，否则认为是不同源。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http://www.baidu.com/123.png            target</span><br><span class="line">http://www.baidu.com/456.png            同源</span><br><span class="line">http://www.baidu.com:800/login.html     跨域(端口号不同)</span><br><span class="line">https://www.baidu.com/456.png           跨域(协议不同)</span><br><span class="line">http://bbs.baidu.com   			跨域(子域名不同)</span><br><span class="line">http://www.taobao.com 			跨域(域名不同)</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>下面给出示例代码发送跨域网络请求：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//当前路径：http://localhost:63342/..demo.html</span></span><br><span class="line"><span class="comment">//请求路径：http://www.baidu.com</span></span><br><span class="line">$.ajax(&#123;</span><br><span class="line">       <span class="string">"url"</span>:<span class="string">"http://www.baidu.com"</span>,</span><br><span class="line">       <span class="string">"type"</span>:<span class="string">"get"</span>,</span><br><span class="line">       <span class="string">"success"</span>:<span class="function"><span class="keyword">function</span> (<span class="params">res,status,xhr</span>) </span>&#123;</span><br><span class="line">           <span class="built_in">console</span>.log(res);</span><br><span class="line">       &#125;,</span><br><span class="line">       <span class="string">"error"</span>:<span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">           <span class="built_in">console</span>.log(res);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure></p>
<p><strong>网络请求结果</strong><br><img src="https://github.com/flowerField/Source/blob/master/Blog/ty_01.png?raw=true" height="200"><br>通过调试发现，该请求确实发送出去甚至收到了服务器返回的响应头信息，但无法获取响应体数据。<br><img src="https://github.com/flowerField/Source/blob/master/Blog/ty_02.png?raw=true"><br>具体报错信息显示：<span style="color:#F44">No ‘Access-Control-Allow-Origin’ header …`</span>意思就是当前域名无法跨域向<a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a>请求数据。</p>
<h3 id="1-2-跨域请求"><a href="#1-2-跨域请求" class="headerlink" title="1.2 跨域请求"></a>1.2 跨域请求</h3><p>在开发中，有时候我们自己的站点需要向其他站点发送网络请求获取服务或某些特定的资源，这就需要跨域发送网络请求。</p>
<p>跨域网络请求有多种方式来实现，比较常见的是：<code>跨域资源共享( CORS )和jsonP</code>。</p>
<h4 id="1-2-1-跨域资源共享-CORS"><a href="#1-2-1-跨域资源共享-CORS" class="headerlink" title="1.2.1 跨域资源共享(CORS)"></a>1.2.1 跨域资源共享(CORS)</h4><p>CORS是一个W3C标准，全称是”跨域资源共享”（<code>Cross-origin resource sharing</code>）。<br>它允许浏览器向跨域的服务器发出XMLHttpRequest请求，从而克服了AJAX只能同源使用的限制。</p>
<p>实现CORS通信的关键是服务器。只要服务器实现了CORS接口，就可以跨源通信，实现方式非常简单，只需要在请求的响应头中设置<code>Access-Control-Allow-Origin</code>字段即可。该字段的值可以设置为指定的域，表明允许该指定的域向服务器发送跨域网络请求，也可以设置为*，表示允许任何的域向服务器发送网络请求。</p>
<p>下面给出php服务器端的响应头设置代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 允许所有其他域名访问</span></span><br><span class="line">header(<span class="string">"Access-Control-Allow-Origin: *"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许指定域名跨域访问</span></span><br><span class="line">header(<span class="string">"Access-Control-Allow-Origin: http://www.wendingding.com"</span>);</span><br></pre></td></tr></table></figure></p>
<p>实现细节请参考：<a href="http://www.ruanyifeng.com/blog/2016/04/cors.html" target="_blank" rel="noopener">阮一峰：跨域资源共享 CORS 详解</a></p>
<p><strong>特别注意</strong> <span style="color:red">跨域请求的时候，请求和响应都不包含Cookie数据</span>。</p>
<h4 id="1-2-2-JSONP"><a href="#1-2-2-JSONP" class="headerlink" title="1.2.2 JSONP"></a>1.2.2 JSONP</h4><p>jsonP是<code>JSON with padding</code>(参数式JSON)的简写，是一种常见的跨域网络请求方案。jsonP和JSON类似，只是把真正要返回给客户端的json数据以特定的方式放在函数调用中作为参数传递。</p>
<p>jsonP方案利用了script标签可以跨越的特点，通过设置script标签的src属性为特定的请求路径来绕过同源访问策略。</p>
<p>jsonP由两部分组成：<span style="color:red">回调函数参数、特定的JSON数据</span></p>
<p><strong>jsonP的基本结构</strong></p>
<blockquote>
<p>① 在页面的script标签中声明回调函数，该回调函数接收参数（需要和响应对应）。<br>② 在页面中动态的创建script标签，并为标签的src属性指定跨域的URL路径。<br>③ 跨域的URL路径中应该附带回调函数参数，例如 <code>http://www.xx.com?cb = fn</code><br>④ 服务器端接收到响应后返回特定格式的数据,例如：<code>fn({&quot;name&quot;:&quot;zs&quot;,&quot;age&quot;:18})</code><br>⑤ 客户端script标签加载跨域路径对应的数据，其实是执行了函数调用，把服务器返回的<code>真正数据</code>作为参数传递给声明的回调函数。</p>
</blockquote>
<p>代码示例（使用百度搜索结果）<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"oText"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params">obj</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">	    <span class="built_in">console</span>.log(obj);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> oUl = <span class="built_in">document</span>.querySelector(<span class="string">"ul"</span>)||<span class="built_in">document</span>.createElement(<span class="string">"ul"</span>);</span></span><br><span class="line"><span class="javascript">        oUl.innerHTML = <span class="string">""</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> arrM = obj[<span class="string">"s"</span>];</span></span><br><span class="line"><span class="javascript">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>;i&lt;arrM.length;i++)</span></span><br><span class="line"><span class="undefined">        &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> oLi = <span class="built_in">document</span>.createElement(<span class="string">"li"</span>);</span></span><br><span class="line"><span class="undefined">            oLi.innerText = arrM[i];</span></span><br><span class="line"><span class="undefined">            oUl.appendChild(oLi);</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.body.appendChild(oUl);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> oText = <span class="built_in">document</span>.querySelector(<span class="string">"#oText"</span>);</span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(oText);</span></span><br><span class="line"><span class="javascript">    oText.onkeyup = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> temp = <span class="built_in">document</span>.querySelector(<span class="string">"#jsonP"</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span>(temp) <span class="built_in">document</span>.body.removeChild(temp);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> text = oText.value;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> oScript = <span class="built_in">document</span>.createElement(<span class="string">"script"</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> url = <span class="string">"https://sp0.baidu.com/5a1Fazu8AA54nxGko9WTAnF6hhy/su?wd="</span>+text+<span class="string">"&amp;cb=fn"</span>;</span></span><br><span class="line"><span class="javascript">        oScript.setAttribute(<span class="string">"src"</span>,url);</span></span><br><span class="line"><span class="javascript">        oScript.setAttribute(<span class="string">"id"</span>,<span class="string">"jsonP"</span>);</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.body.appendChild(oScript);</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://github.com/flowerField/Source/blob/master/Blog/ty_03.png?raw=true"></p>
<hr>
<ul>
<li>Posted by 博客园·<a href="http://www.cnblogs.com/wendingding/" target="_blank" rel="noopener">文顶顶</a> | <a href="http://wendingding.com" target="_blank" rel="noopener">花田半亩</a></li>
<li>联系作者 简书·<a href="http://www.jianshu.com/users/c5703017b9f5/latest_articleshttp://www.jianshu.com/users/c5703017b9f5/latest_articles" target="_blank" rel="noopener">文顶顶</a> 新浪微博·<a href="http://weibo.com/p/1005053800117445/home?from=page_100505&amp;mod=TAB#place">Coder_文顶顶</a></li>
<li>原创文章，版权声明：自由转载-非商用-非衍生-保持署名 | <a href="http://www.cnblogs.com/wendingding/" target="_blank" rel="noopener">文顶顶</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2018/05/12/javaScript系列 [06]-javaScript和this/" class="prev">上一篇</a><a href="/2018/05/08/读书笔记 [005]-牧羊少年奇幻之旅/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2020 <a href="https://weibo.com/u/3800117445">文顶顶</a> &nbsp;☁ 全站字数统计 390.7k (字)</p><div class="topDiv"><div><img src="https://raw.githubusercontent.com/flowerField/Source/master/Blog/M.png" style="width:100px;height:100px"> </div></div><!--p © #{year} #[a(href=config.url)!= config.author], powered by #[a(href=hexoURL, target="_blank") Hexo] and #[a(href=apolloURL, target="_blank") hexo-theme-apollo].--></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>