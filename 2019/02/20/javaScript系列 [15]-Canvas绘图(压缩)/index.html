<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> javaScript系列 [15]-Canvas绘图(压缩) · 花田半亩</title><meta name="description" content="javaScript系列 [15]-Canvas绘图(压缩) - 文顶顶"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/logo.jpeg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://weibo.com/u/3800117445/atom.xml" title="花田半亩"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/鲸鱼.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">文顶顶的BLOG</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">标签</a></li><li class="nav-list-item"><a href="https://www.cnblogs.com/wendingding/" target="_blank" class="nav-list-link">博客园</a></li><li class="nav-list-item"><a href="http://weibo.com/p/1005053800117445/home?from=page_100505&amp;mod=TAB#place" target="_blank" class="nav-list-link">微博</a></li><li class="nav-list-item"><a href="http://blog.sina.com.cn/u/1910914290" target="_blank" class="nav-list-link">花田半亩</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">javaScript系列 [15]-Canvas绘图(压缩)</h1><div class="post-info">Feb 20, 2019<span class="post-count"></span> ✧ 字数统计:1,430(字) &nbsp;&nbsp; ♨︎ 阅读时长:6(分钟)</div><div class="post-content"><p class="tip">写这篇文章的原因是因为今天早上的时候，突然遇到个需求需要等比例调整照片的大小（主要是想把图片等比例的缩小），我在Mac上通过图片处理软件捣鼓的时候发现比较麻烦，就随手百度了一个在线修改图片尺寸的网站，叫做<a href="http://www.gaitubao.com/" target="_blank" rel="noopener">改图宝</a>。这个网站提供给图片加logo、修改图片尺寸以及印章制作等诸多功能，界面简洁使用方便解决了我的问题，值得推荐。<br><br>然而，等到中午的时候，我发现还有一张图片需要处理，恰好电脑连不上网络，我就考虑能不能通过代码自己来实现，因为图片的<strong><code>选择 - 压缩 - 上传</code></strong>在实际开发中也是对应的场景，因此本文将介绍如何利用Canvas画布来对图片进行压缩的技术，包括实现思路和具体的代码。</p>

<div class="titleX"><strong>实现思路</strong></div>

<p><img src="https://github.com/flowerField/Source/blob/master/Blog/canvas_38.png?raw=true"></p>
<p><strong>[ 1 ] 获取源图像数据</strong></p>
<p>在页面中我们使用<code>input标签(file类型)</code>来让用户选择对应的文件上传。为了等比例的对图片进行压缩，需要获取源图片的宽度和高度等数据参数，这里使用了<strong><a href="">FileReader构造函数</a></strong>(类)。</p>
<p>具体实现的时候，先调用<code>new FileReader()</code>创建一个FileReader的实例对象，然后为<code>input标签</code>注册<span style="color:red">change</span>事件监听。当用户选择好文件后，需要先检查是否是图片(<a href="https://www.iana.org/assignments/media-types/media-types.xhtml" target="_blank" rel="noopener">通过MIMEType类型判断</a>)，再通过FileReader实例来调用<code>readAsDataURL(file)</code>方法来读取图片文件的数据信息，以获取源图片文件的宽度和高度信息。</p>
<p><strong>[ 2 ] 计算宽高压缩比数据</strong></p>
<p>因为示例代码中演示的等比例的进行缩放(压缩)，因此需要通过得到目标图片的宽度和高度尺寸数据。<br>这里列出计算部分的<strong><span style="color:red">核心代码</span></strong>：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> targetWidth,targetHeight;</span><br><span class="line"><span class="keyword">var</span> imgWidth = img.width, imgHeight = img.height;</span><br><span class="line"><span class="keyword">var</span> maxWidth = <span class="number">150</span>, maxHeight = <span class="number">150</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果图片尺寸超过限制，那么需要重新计算宽高</span></span><br><span class="line"><span class="keyword">if</span> (imgWidth &gt; maxWidth || imgHeight &gt; maxHeight) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (imgWidth / imgHeight &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果更宽，那么就按照宽度限定尺寸</span></span><br><span class="line">    targetWidth = maxWidth;</span><br><span class="line">    targetHeight = <span class="built_in">Math</span>.round(maxWidth * (imgHeight / imgWidth));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 如果更高，那么就按照高度限定尺寸</span></span><br><span class="line">    targetHeight = maxHeight;</span><br><span class="line">    targetWidth = <span class="built_in">Math</span>.round(maxHeight * (imgWidth / imgHeight));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>[ 3 ] 绘制目标图片</strong></p>
<p>当目标图片(压缩后)的宽高都计算完成后，可以通过Canvas上下文的<code>drawImage</code>方法来完成图片的绘制，该方法的具体使用可以参考<a href="http://wendingding.com/2019/02/05/javaScript%E7%B3%BB%E5%88%97%20[14]-Canvas%E7%BB%98%E5%9B%BE(%E5%9B%BE%E5%83%8F" target="_blank" rel="noopener"> javaScript系列 [14]-Canvas绘图(图像)</a>这篇文章。</p>
<p><code>drawImage</code>方法的第一个参数为需要绘制的图片数据，该图片数据即为用户通过input标签选择的文件内容。当然，在具体实现的时候还需要读取文件的内容，监听加载完毕之后再设置Image数据源。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">reader.onload = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  /e.target.result是图片的base64地址信息</span><br><span class="line">  img.src = event.target.result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="titleX"><strong>完整代码</strong></div>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">  &lt;title&gt;Title&lt;<span class="regexp">/title&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;input type=<span class="string">"file"</span> id=<span class="string">"file"</span>&gt;</span><br><span class="line">&lt;div id=<span class="string">"info"</span> style=<span class="string">"font-size: 13px"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">&lt;canvas id=<span class="string">"canvas"</span> height=<span class="string">"200"</span> width=<span class="string">"200"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span></span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//[1] 获取页面中的文件选择标签</span></span><br><span class="line">  <span class="keyword">var</span> oInput  = <span class="built_in">document</span>.querySelector(<span class="string">'#file'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//[2] 创建FileReader对象用于读取文件信息</span></span><br><span class="line">  <span class="keyword">var</span> reader = <span class="keyword">new</span> FileReader();</span><br><span class="line">  <span class="keyword">var</span> file   = <span class="literal">null</span>;  <span class="comment">//文件对象</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//[3] 给文件选择标签添加事件监听</span></span><br><span class="line">  oInput.addEventListener(<span class="string">'change'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//001 获取用户选择的文件</span></span><br><span class="line">    file = event.target.files[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//002 获取文件的MIMEType类型</span></span><br><span class="line">    <span class="keyword">var</span> fileType = file.type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//003 检查用户选择的文件是否是图片</span></span><br><span class="line">    <span class="keyword">if</span> (fileType.indexOf(<span class="string">"image"</span>) == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//004 如果发现文件是图片则读取图片为DataURL</span></span><br><span class="line">      reader.readAsDataURL(file);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//[4] 创建Image图像实例</span></span><br><span class="line">  <span class="keyword">var</span> img  = <span class="keyword">new</span> Image();</span><br><span class="line">  <span class="keyword">var</span> targetWidth,targetHeight;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//[5] 监听FileReader对象是否处理完毕，设置图像实例的数据源</span></span><br><span class="line">  reader.onload = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//说明：e.target.result是图片的base64地址信息</span></span><br><span class="line">    img.src = event.target.result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//[6] 监听Image实例加载，压缩图片并生成预览图像</span></span><br><span class="line">    img.onload = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">      setFileInfo();</span><br><span class="line"></span><br><span class="line">      <span class="comment">//[7]在页面中创建canvas画布对图片进行缩放(压缩)后绘制</span></span><br><span class="line">      <span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">"canvas"</span>);</span><br><span class="line">      <span class="keyword">var</span> ctx = canvas.getContext(<span class="string">"2d"</span>);</span><br><span class="line">      ctx.clearRect(<span class="number">0</span>,<span class="number">0</span>,ctx.canvas.width,ctx.canvas.height);</span><br><span class="line">      ctx.drawImage(img, <span class="number">0</span>, <span class="number">0</span>, targetWidth, targetHeight);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setFileInfo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 获取文件的名称</span></span><br><span class="line">      <span class="keyword">var</span> fileName = file.name;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获取文件的大小</span></span><br><span class="line">      <span class="keyword">var</span> fileSize = (file.size / <span class="number">1024</span> / <span class="number">1024</span>).toFixed(<span class="number">3</span>) + <span class="string">"M"</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 图片压缩比计算</span></span><br><span class="line">      <span class="keyword">var</span> imgWidth = img.width, imgHeight = img.height;</span><br><span class="line">      <span class="keyword">var</span> maxWidth = <span class="number">150</span>, maxHeight = <span class="number">150</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果图片尺寸超过限制，那么需要重新计算宽高</span></span><br><span class="line">      <span class="keyword">if</span> (imgWidth &gt; maxWidth || imgHeight &gt; maxHeight) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (imgWidth / imgHeight &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">          <span class="comment">// 如果更宽，那么就按照宽度限定尺寸</span></span><br><span class="line">          targetWidth = maxWidth;</span><br><span class="line">          targetHeight = <span class="built_in">Math</span>.round(maxWidth * (imgHeight / imgWidth));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 如果更高，那么就按照高度限定尺寸</span></span><br><span class="line">          targetHeight = maxHeight;</span><br><span class="line">          targetWidth = <span class="built_in">Math</span>.round(maxHeight * (imgWidth / imgHeight));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//在页面中显示图片信息</span></span><br><span class="line">        <span class="keyword">var</span> html = <span class="string">"&lt;div&gt;1.已选择图片"</span> + fileName + <span class="string">"，大小为"</span> + fileSize + <span class="string">"。&lt;/div&gt;\n"</span> +</span><br><span class="line">            <span class="string">"&lt;div&gt;2.图片原尺寸是："</span> + imgWidth + <span class="string">" x "</span> + imgHeight + <span class="string">"&lt;/div&gt;\n"</span> +</span><br><span class="line">            <span class="string">"&lt;div&gt;3.图片压缩尺寸："</span> + maxWidth + <span class="string">" x "</span> + maxHeight + <span class="string">"&lt;/div&gt;\n"</span> +</span><br><span class="line">            <span class="string">"&lt;div&gt;4.图片已压缩为："</span> + targetWidth + <span class="string">" x "</span> + targetHeight +<span class="string">"&lt;/div&gt;\n"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> oDiv = <span class="built_in">document</span>.getElementById(<span class="string">"info"</span>);</span><br><span class="line">        oDiv.innerHTML = html;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>body&gt;</span><br><span class="line">&lt;<span class="regexp">/html&gt;</span></span><br></pre></td></tr></table></figure>
<p><div class="titleX"><strong>演示效果</strong></div><br><img src="https://github.com/flowerField/Source/blob/master/Blog/canvas_37.gif?raw=true"></p>
<hr>
<ul>
<li>Posted by 博客园·<a href="http://www.cnblogs.com/wendingding/" target="_blank" rel="noopener">文顶顶</a> | <a href="http://wendingding.com" target="_blank" rel="noopener">花田半亩</a></li>
<li>联系作者 简书·<a href="http://www.jianshu.com/users/c5703017b9f5/latest_articleshttp://www.jianshu.com/users/c5703017b9f5/latest_articles" target="_blank" rel="noopener">文顶顶</a> 新浪微博·<a href="http://weibo.com/p/1005053800117445/home?from=page_100505&amp;mod=TAB#place">Coder_文顶顶</a></li>
<li>原创文章，版权声明：自由转载-非商用-非衍生-保持署名 | <a href="http://www.cnblogs.com/wendingding/" target="_blank" rel="noopener">文顶顶</a></li>
</ul>
</div></article></div></main><footer><div class="paginator"><a href="/2019/02/21/开发工具系列 Webstorm常用快捷键/" class="prev">上一篇</a><a href="/2019/02/05/javaScript系列 [14]-Canvas绘图(图像)/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2019 <a href="https://weibo.com/u/3800117445">文顶顶</a> &nbsp;☁ 全站字数统计 347.7k (字)</p><div class="topDiv"><div><img src="https://raw.githubusercontent.com/flowerField/Source/master/Blog/M.png" style="width:100px;height:100px"> </div></div><!--p © #{year} #[a(href=config.url)!= config.author], powered by #[a(href=hexoURL, target="_blank") Hexo] and #[a(href=apolloURL, target="_blank") hexo-theme-apollo].--></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>